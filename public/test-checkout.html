<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Testing Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Checkout Testing Page</h1>
        
        <!-- Products Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Available Products</h2>
            <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Products will be loaded here -->
            </div>
            <div class="mt-4">
                <button onclick="loadSampleProducts()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    Load Sample Products
                </button>
            </div>
        </div>

        <!-- Shopping Cart Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Shopping Cart</h2>
            <div id="cart-items" class="space-y-4">
                <p class="text-gray-500">Your cart is empty</p>
            </div>
            <div class="mt-6 pt-4 border-t">
                <div class="flex justify-between items-center text-xl font-semibold">
                    <span>Total: $<span id="cart-total">0.00</span></span>
                    <button onclick="clearCart()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm">
                        Clear Cart
                    </button>
                </div>
            </div>
        </div>

        <!-- Checkout Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Checkout Options</h2>
            
            <!-- User ID Input -->
            <div class="mb-4">
                <label for="user-id" class="block text-sm font-medium text-gray-700 mb-2">User ID (RSPS Username)</label>
                <input type="text" id="user-id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                       placeholder="Enter your RSPS username" value="testuser123">
            </div>

            <!-- Payment Method Buttons -->
            <div class="flex space-x-4">
                <button onclick="checkout('paypal')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 disabled:opacity-50" 
                        id="paypal-btn" disabled>
                    <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106zm14.146-14.42a3.35 3.35 0 0 0-.607-.541c-.013.076-.026.175-.041.26-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81.454.518.769 1.13.962 1.837.193.707.264 1.507.112 2.37z"/>
                    </svg>
                    Checkout with PayPal
                </button>
                
                <button onclick="checkout('coinbase')" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold flex-1 disabled:opacity-50" 
                        id="coinbase-btn" disabled>
                    <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 24C5.373 24 0 18.627 0 12S5.373 0 12 0s12 5.373 12 12-5.373 12-12 12zm-1.5-15.5v7h3v-7h-3z"/>
                    </svg>
                    Checkout with Coinbase
                </button>
            </div>
        </div>

        <!-- API Response Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">API Response</h2>
            <pre id="api-response" class="bg-gray-100 p-4 rounded text-sm overflow-auto max-h-96">
No API calls made yet...
            </pre>
        </div>
    </div>

    <script>
        let cart = [];
        let products = [];

        // Sample products data
        const sampleProducts = [
            {
                id: 1,
                name: "Dragon Scimitar",
                description: "A powerful melee weapon",
                price: 0.01,
                image: "https://via.placeholder.com/150x150/4F46E5/FFFFFF?text=Dragon+Scim"
            },
            {
                id: 2,
                name: "Abyssal Whip",
                description: "High-level whip weapon",
                price: 19.99,
                image: "https://via.placeholder.com/150x150/DC2626/FFFFFF?text=Abyssal+Whip"
            },
            {
                id: 3,
                name: "Bandos Chestplate",
                description: "Strong melee armor",
                price: 29.99,
                image: "https://via.placeholder.com/150x150/059669/FFFFFF?text=Bandos+Chest"
            },
            {
                id: 4,
                name: "Dharok's Set",
                description: "Complete Dharok's barrows set",
                price: 49.99,
                image: "https://via.placeholder.com/150x150/7C2D12/FFFFFF?text=Dharoks+Set"
            },
            {
                id: 5,
                name: "Party Hat (Blue)",
                description: "Rare cosmetic item",
                price: 99.99,
                image: "https://via.placeholder.com/150x150/1E40AF/FFFFFF?text=Party+Hat"
            },
            {
                id: 6,
                name: "Dragon Bones (100x)",
                description: "Stack of 100 dragon bones",
                price: 14.99,
                image: "https://via.placeholder.com/150x150/6B7280/FFFFFF?text=Dragon+Bones"
            }
        ];

        // Load sample products
        function loadSampleProducts() {
            products = sampleProducts;
            renderProducts();
            updateApiResponse('Sample products loaded successfully', 'info');
        }

        // Render products grid
        function renderProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = products.map(product => `
                <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                    <img src="${product.image}" alt="${product.name}" class="w-full h-32 object-cover rounded mb-3">
                    <h3 class="font-semibold text-lg mb-2">${product.name}</h3>
                    <p class="text-gray-600 text-sm mb-3">${product.description}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-bold text-green-600">$${product.price}</span>
                        <button onclick="addToCart(${product.id})" 
                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm">
                            Add to Cart
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Add product to cart
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...product,
                    quantity: 1
                });
            }
            
            renderCart();
            updateCheckoutButtons();
            updateApiResponse(`Added ${product.name} to cart`, 'success');
        }

        // Remove from cart
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            renderCart();
            updateCheckoutButtons();
            updateApiResponse('Item removed from cart', 'info');
        }

        // Update quantity
        function updateQuantity(productId, newQuantity) {
            if (newQuantity <= 0) {
                removeFromCart(productId);
                return;
            }
            
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity = newQuantity;
                renderCart();
                updateCheckoutButtons();
            }
        }

        // Clear cart
        function clearCart() {
            cart = [];
            renderCart();
            updateCheckoutButtons();
            updateApiResponse('Cart cleared', 'info');
        }

        // Render cart
        function renderCart() {
            const cartContainer = document.getElementById('cart-items');
            const totalElement = document.getElementById('cart-total');
            
            if (cart.length === 0) {
                cartContainer.innerHTML = '<p class="text-gray-500">Your cart is empty</p>';
                totalElement.textContent = '0.00';
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            totalElement.textContent = total.toFixed(2);

            cartContainer.innerHTML = cart.map(item => `
                <div class="flex items-center justify-between p-4 border rounded-lg">
                    <div class="flex items-center space-x-4">
                        <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded">
                        <div>
                            <h4 class="font-semibold">${item.name}</h4>
                            <p class="text-gray-600">$${item.price} each</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="updateQuantity(${item.id}, ${item.quantity - 1})" 
                                class="bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded">-</button>
                        <span class="font-semibold w-8 text-center">${item.quantity}</span>
                        <button onclick="updateQuantity(${item.id}, ${item.quantity + 1})" 
                                class="bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded">+</button>
                        <button onclick="removeFromCart(${item.id})" 
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm ml-4">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        // Update checkout buttons state
        function updateCheckoutButtons() {
            const paypalBtn = document.getElementById('paypal-btn');
            const coinbaseBtn = document.getElementById('coinbase-btn');
            const hasItems = cart.length > 0;
            
            paypalBtn.disabled = !hasItems;
            coinbaseBtn.disabled = !hasItems;
        }

        // Checkout function
        async function checkout(paymentMethod) {
            const userId = document.getElementById('user-id').value.trim();
            
            if (!userId) {
                updateApiResponse('Please enter a User ID', 'error');
                return;
            }

            if (cart.length === 0) {
                updateApiResponse('Cart is empty', 'error');
                return;
            }

            const checkoutData = {
                user_id: userId,
                payment_method: paymentMethod,
                items: cart.map(item => ({
                    product_id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                })),
                currency: 'USD'
            };

            try {
                updateApiResponse('Processing checkout...', 'info');
                
                // Make API call to checkout endpoint
                const response = await axios.post('/api/checkout', checkoutData, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                updateApiResponse(JSON.stringify(response.data, null, 2), 'success');
                
                // If checkout successful and has payment URL, open in new tab
                if (response.data.success && response.data.payment_url) {
                    updateApiResponse(`Checkout successful! Opening ${paymentMethod} payment page...`, 'success');
                    window.open(response.data.payment_url, '_blank');
                } else if (response.data.checkout_url) {
                    updateApiResponse(`Checkout successful! Opening ${paymentMethod} payment page...`, 'success');
                    window.open(response.data.checkout_url, '_blank');
                }

            } catch (error) {
                console.error('Checkout error:', error);
                let errorMessage = 'Checkout failed: ';
                
                if (error.response) {
                    errorMessage += JSON.stringify(error.response.data, null, 2);
                } else if (error.request) {
                    errorMessage += 'No response from server. Make sure the API is running.';
                } else {
                    errorMessage += error.message;
                }
                
                updateApiResponse(errorMessage, 'error');
            }
        }

        // Update API response display
        function updateApiResponse(message, type = 'info') {
            const responseElement = document.getElementById('api-response');
            const timestamp = new Date().toLocaleTimeString();
            
            let color = 'text-gray-800';
            if (type === 'success') color = 'text-green-800';
            if (type === 'error') color = 'text-red-800';
            if (type === 'info') color = 'text-blue-800';
            
            responseElement.innerHTML = `<div class="${color}"><strong>[${timestamp}]</strong> ${message}</div>`;
            responseElement.scrollTop = responseElement.scrollHeight;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSampleProducts();
            updateCheckoutButtons();
            updateApiResponse('Page loaded. Add items to cart and test checkout!', 'info');
        });

        // Test API connectivity
        async function testApiConnection() {
            try {
                const response = await axios.get('/api/products');
                updateApiResponse('API connection successful!', 'success');
                return true;
            } catch (error) {
                updateApiResponse('API connection failed. Using sample data.', 'error');
                return false;
            }
        }

        // Load products from API if available
        async function loadProductsFromApi() {
            try {
                const response = await axios.get('/api/products');
                if (response.data && response.data.data) {
                    products = response.data.data;
                    renderProducts();
                    updateApiResponse('Products loaded from API', 'success');
                } else {
                    loadSampleProducts();
                }
            } catch (error) {
                loadSampleProducts();
            }
        }
    </script>
</body>
</html>